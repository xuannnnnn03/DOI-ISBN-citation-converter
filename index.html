<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOI & ISBN Citation Generator - Debug</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #ffd700;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --danger: #e74c3c;
      --border-radius: 6px;
      --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.5;
      background-color: #f0f2f5;
      color: #333;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    h1 {
      color: var(--primary);
    }
    
    .debug-panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .debug-title {
      font-size: 1.3rem;
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent);
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .test-result {
      margin-top: 15px;
      padding: 15px;
      border-radius: var(--border-radius);
      background: var(--light);
      display: none;
    }
    
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: var(--border-radius);
      overflow: auto;
      max-height: 300px;
    }
    
    .success {
      border-left: 4px solid var(--success);
    }
    
    .error {
      border-left: 4px solid var(--danger);
    }
    
    .endpoint-test {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
    }
    
    .log-output {
      height: 200px;
      overflow-y: auto;
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <header>
    <h1>DOI & ISBN Citation Generator - Debug Panel</h1>
    <p>Debugging BibTeX download issue on DigitalOcean</p>
  </header>

  <div class="debug-panel">
    <h2 class="debug-title">Environment Tests</h2>
    
    <div class="endpoint-test">
      <h3>Test API Endpoints</h3>
      <p>Check if your API endpoints are responding correctly:</p>
      <button class="btn" onclick="testEndpoint('/cite', 'POST', {identifier: '10.1038/nature12373', type: 'doi', style: 'APA'})">Test /cite Endpoint</button>
      <button class="btn" onclick="testEndpoint('/cite_bibtex', 'POST', {identifier: '10.1038/nature12373', type: 'doi', style: 'APA'})">Test /cite_bibtex Endpoint</button>
      <button class="btn" onclick="testEndpoint('/upload', 'POST', null, true)">Test /upload Endpoint</button>
      
      <div id="endpointResult" class="test-result"></div>
    </div>
    
    <div class="endpoint-test">
      <h3>Test BibTeX Generation</h3>
      <p>Test if BibTeX generation is working correctly:</p>
      <button class="btn btn-success" onclick="testBibTeX('10.1038/nature12373', 'doi')">Test DOI BibTeX</button>
      <button class="btn btn-success" onclick="testBibTeX('9780451524935', 'isbn')">Test ISBN BibTeX</button>
      
      <div id="bibtexResult" class="test-result"></div>
    </div>
    
    <div class="endpoint-test">
      <h3>Debug Download Function</h3>
      <p>Test the download function with different scenarios:</p>
      <button class="btn" onclick="testDownload('single')">Test Single Citation Download</button>
      <button class="btn" onclick="testDownload('multiple')">Test Multiple Citations Download</button>
      
      <div id="downloadResult" class="test-result"></div>
    </div>
  </div>

  <div class="debug-panel">
    <h2 class="debug-title">Configuration Check</h2>
    
    <div class="endpoint-test">
      <h3>Environment Variables</h3>
      <p>Check if your environment is configured correctly:</p>
      <button class="btn" onclick="checkEnvironment()">Check Environment</button>
      
      <div id="environmentResult" class="test-result"></div>
    </div>
    
    <div class="endpoint-test">
      <h3>API Base URL</h3>
      <p>Current API base URL: <strong id="apiBaseUrl"></strong></p>
      <p>If this is incorrect, you may need to set it explicitly in your code.</p>
    </div>
  </div>

  <div class="debug-panel">
    <h2 class="debug-title">Debug Log</h2>
    <div class="log-output" id="debugLog"></div>
  </div>

  <script>
    // Set the API base URL
    const apiBaseUrl = window.location.origin;
    document.getElementById('apiBaseUrl').textContent = apiBaseUrl;
    
    // Debug logging function
    function logDebug(message, type = 'info') {
      const logElement = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#339af0'}">${message}</span>`;
      logElement.appendChild(logEntry);
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // Test API endpoint
    async function testEndpoint(endpoint, method, data = null, isFormData = false) {
      const resultElement = document.getElementById('endpointResult');
      resultElement.style.display = 'block';
      
      try {
        logDebug(`Testing ${endpoint} endpoint...`);
        
        let options = {
          method: method,
          headers: {}
        };
        
        if (data && !isFormData) {
          options.headers['Content-Type'] = 'application/json';
          options.body = JSON.stringify(data);
        }
        
        if (isFormData) {
          // Create a simple text file for testing
          const formData = new FormData();
          const fileContent = '10.1038/nature12373\n9780451524935';
          const blob = new Blob([fileContent], { type: 'text/plain' });
          formData.append('file', blob, 'test.txt');
          formData.append('style', 'APA');
          options.body = formData;
        }
        
        const response = await fetch(apiBaseUrl + endpoint, options);
        const responseData = await response.json();
        
        resultElement.innerHTML = `
          <h4>Response from ${endpoint}:</h4>
          <p>Status: ${response.status} ${response.statusText}</p>
          <pre>${JSON.stringify(responseData, null, 2)}</pre>
        `;
        resultElement.className = 'test-result success';
        
        logDebug(`Endpoint ${endpoint} responded successfully`, 'success');
      } catch (error) {
        resultElement.innerHTML = `
          <h4>Error testing ${endpoint}:</h4>
          <p>${error.message}</p>
        `;
        resultElement.className = 'test-result error';
        
        logDebug(`Error testing ${endpoint}: ${error.message}`, 'error');
      }
    }
    
    // Test BibTeX generation
    async function testBibTeX(identifier, type) {
      const resultElement = document.getElementById('bibtexResult');
      resultElement.style.display = 'block';
      
      try {
        logDebug(`Testing BibTeX generation for ${identifier} (${type})...`);
        
        const response = await fetch(apiBaseUrl + '/cite_bibtex', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            identifier: identifier,
            type: type,
            style: 'APA'
          })
        });
        
        const data = await response.json();
        
        if (data.bibtex) {
          resultElement.innerHTML = `
            <h4>BibTeX generated successfully:</h4>
            <pre>${data.bibtex}</pre>
          `;
          resultElement.className = 'test-result success';
          logDebug(`BibTeX generated successfully for ${identifier}`, 'success');
        } else {
          resultElement.innerHTML = `
            <h4>BibTeX generation failed:</h4>
            <p>Response: ${JSON.stringify(data)}</p>
          `;
          resultElement.className = 'test-result error';
          logDebug(`BibTeX generation failed for ${identifier}`, 'error');
        }
      } catch (error) {
        resultElement.innerHTML = `
          <h4>Error testing BibTeX generation:</h4>
          <p>${error.message}</p>
        `;
        resultElement.className = 'test-result error';
        logDebug(`Error testing BibTeX generation: ${error.message}`, 'error');
      }
    }
    
    // Test download function
    async function testDownload(type) {
      const resultElement = document.getElementById('downloadResult');
      resultElement.style.display = 'block';
      
      try {
        logDebug(`Testing ${type} citation download...`);
        
        let bibtexData;
        
        if (type === 'single') {
          // Test single citation download
          const response = await fetch(apiBaseUrl + '/cite_bibtex', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              identifier: '10.1038/nature12373',
              type: 'doi',
              style: 'APA'
            })
          });
          
          bibtexData = await response.json();
        } else {
          // Test multiple citations download
          const formData = new FormData();
          const fileContent = '10.1038/nature12373\n9780451524935';
          const blob = new Blob([fileContent], { type: 'text/plain' });
          formData.append('file', blob, 'test.txt');
          formData.append('style', 'APA');
          
          const response = await fetch(apiBaseUrl + '/upload', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          bibtexData = { bibtex: data.map(item => item.bibtex).join('\n\n') };
        }
        
        if (bibtexData.bibtex && !bibtexData.bibtex.includes('undefined')) {
          resultElement.innerHTML = `
            <h4>Download test successful:</h4>
            <pre>${bibtexData.bibtex}</pre>
          `;
          resultElement.className = 'test-result success';
          logDebug(`${type} citation download test successful`, 'success');
        } else {
          resultElement.innerHTML = `
            <h4>Download test failed:</h4>
            <p>BibTeX content contains "undefined" or is empty</p>
            <pre>${bibtexData.bibtex || 'No content'}</pre>
          `;
          resultElement.className = 'test-result error';
          logDebug(`${type} citation download test failed - content contains "undefined"`, 'error');
        }
      } catch (error) {
        resultElement.innerHTML = `
          <h4>Error testing download:</h4>
          <p>${error.message}</p>
        `;
        resultElement.className = 'test-result error';
        logDebug(`Error testing download: ${error.message}`, 'error');
      }
    }
    
    // Check environment configuration
    async function checkEnvironment() {
      const resultElement = document.getElementById('environmentResult');
      resultElement.style.display = 'block';
      
      try {
        logDebug('Checking environment configuration...');
        
        // Test if we can access the API
        const response = await fetch(apiBaseUrl + '/');
        const text = await response.text();
        
        let environmentInfo = `
          <h4>Environment Check:</h4>
          <p>API Base URL: ${apiBaseUrl}</p>
          <p>Root endpoint accessible: ${response.status === 200 ? 'Yes' : 'No'}</p>
        `;
        
        // Check if we're on localhost or production
        const isLocalhost = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
        
        environmentInfo += `<p>Environment: ${isLocalhost ? 'Localhost' : 'Production'}</p>`;
        
        resultElement.innerHTML = environmentInfo;
        resultElement.className = 'test-result success';
        
        logDebug('Environment check completed successfully', 'success');
      } catch (error) {
        resultElement.innerHTML = `
          <h4>Error checking environment:</h4>
          <p>${error.message}</p>
        `;
        resultElement.className = 'test-result error';
        logDebug(`Error checking environment: ${error.message}`, 'error');
      }
    }
    
    // Initialize
    logDebug('Debug panel initialized');
    checkEnvironment();
  </script>
</body>
</html>
